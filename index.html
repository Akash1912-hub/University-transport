<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        .logo {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
        }

        .logo img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .nav-menu {
            flex: 1;
            padding: 0 20px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ccc;
        }

        .nav-item:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .nav-item.active {
            background: #7c3aed;
            color: #ffffff;
        }

        .nav-item i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        .footer-icon {
            color: #888;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .footer-icon:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            background: #0f0f0f;
            overflow-y: auto;
        }

        .top-bar {
            background: #1a1a1a;
            padding: 20px 30px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .back-button {
            color: #888;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
        }

        .content-area {
            padding: 30px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: #ffffff;
        }

        .section-icon {
            color: #7c3aed;
            font-size: 1.5rem;
        }

        /* Upload Section */
        .upload-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .upload-area {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #0f0f0f;
        }

        .upload-area:hover {
            border-color: #7c3aed;
            background: #1a1a1a;
        }

        .upload-area.dragover {
            border-color: #7c3aed;
            background: #1a1a1a;
        }

        .upload-icon {
            font-size: 3rem;
            color: #7c3aed;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #888;
        }

        .file-input {
            display: none;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #7c3aed;
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #6d28d9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #374151;
            color: #ffffff;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #4b5563;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* File Info */
        .file-info {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .file-info h4 {
            color: #ffffff;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .file-info p {
            color: #ccc;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #333;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #7c3aed;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #7c3aed;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #ccc;
            font-weight: 500;
        }

        /* Map Container */
        .map-container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #333;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        #optimize-map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #1a1a1a;
        }

        /* Messages */
        .message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .error {
            background: #dc2626;
            color: white;
            border-left: 4px solid #ef4444;
        }

        .success {
            background: #059669;
            color: white;
            border-left: 4px solid #10b981;
        }

        .warning {
            background: #d97706;
            color: white;
            border-left: 4px solid #f59e0b;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: #1a1a1a;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #7c3aed;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Route Info */
        .route-info {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .route-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .route-stat {
            text-align: center;
            padding: 20px;
            background: #0f0f0f;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .route-stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #7c3aed;
        }

        .route-stat-label {
            font-size: 0.85rem;
            color: #ccc;
            margin-top: 5px;
        }

        /* Legend */
        .legend {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .legend-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #333;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .nav-menu {
                display: flex;
                overflow-x: auto;
                padding: 0 20px;
            }
            
            .nav-item {
                white-space: nowrap;
                margin-right: 15px;
            }
        }

        @media (max-width: 768px) {
            .content-area {
                padding: 20px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 400px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #7c3aed;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="rec.png" alt="Rajalakshmi Engineering College" style="width: 150px; height: 60px; object-fit: contain; ">
                </div>
                <div class="logo-subtitle">Transport Management System</div>
            </div>
            
            <div class="nav-menu">
                <div class="nav-item" data-section="dashboard">
                    <i class="fas fa-th-large"></i>
                    Dashboard
                </div>
                <div class="nav-item" data-section="upload">
                    <i class="fas fa-upload"></i>
                    Upload Data
                </div>
                <div class="nav-item" data-section="visualize">
                    <i class="fas fa-map-marked-alt"></i>
                    Visualize Points
                </div>
                <div class="nav-item" data-section="optimize">
                    <i class="fas fa-route"></i>
                    Optimize Routes
                </div>
                <div class="nav-item" data-section="statistics">
                    <i class="fas fa-chart-bar"></i>
                    Statistics
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    Settings
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="footer-icon">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <div class="footer-icon">
                    <i class="fas fa-sun"></i>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <div class="back-button">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="page-title">Transport Management</div>
            </div>

            <div class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboard-section" class="section">
                    <div class="section-header">
                        <i class="fas fa-th-large section-icon"></i>
                        <div class="section-title">Dashboard</div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="dashboardPoints">0</div>
                            <div class="stat-label">Boarding Points</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="dashboardStudents">0</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="dashboardRoutes">0</div>
                            <div class="stat-label">Optimized Routes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="dashboardDistance">0</div>
                            <div class="stat-label">Total Distance (km)</div>
                        </div>
                    </div>

                    <div class="map-container">
                        <div id="dashboard-map"></div>
                    </div>
                </div>

                <!-- Upload Section -->
                <div id="upload-section" class="section" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-upload section-icon"></i>
                        <div class="section-title">Upload Transport Data</div>
                    </div>
                    
                    <div class="upload-section">
                        <input type="file" id="csvFile" class="file-input" accept=".csv" style="display: none;" />
                        <div class="upload-area" id="fileUpload">
                            <div class="upload-icon">
                                <i class="fas fa-file-csv"></i>
                            </div>
                            <div class="upload-text">Choose CSV File</div>
                            <div class="upload-subtext">or drag and drop here</div>
                        </div>
                        
                        <div class="btn-group">
                            <button id="uploadBtn" class="btn btn-primary" disabled>
                                <i class="fas fa-map-marked-alt"></i>
                                Display Points
                            </button>
                            <button id="routeBtn" class="btn btn-secondary" disabled>
                                <i class="fas fa-route"></i>
                                Optimize Routes
                            </button>
                        </div>
                        
                        <div id="fileInfo" class="file-info" style="display: none;"></div>
                        <div id="message"></div>
                        <div id="loading" class="loading">
                            <div class="spinner"></div>
                            <p id="loadingText">Processing transport data...</p>
                        </div>
                    </div>
                </div>

                <!-- Visualize Section -->
                <div id="visualize-section" class="section" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-map-marked-alt section-icon"></i>
                        <div class="section-title">Visualize Boarding Points</div>
                    </div>
                    
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                    
                    <div class="legend" id="legend" style="display: none;">
                        <div class="legend-title">
                            <i class="fas fa-route"></i> Transport Routes
                        </div>
                        <div class="legend-items" id="legendItems"></div>
                    </div>
                </div>

                <!-- Optimize Section -->
                <div id="optimize-section" class="section" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-route section-icon"></i>
                        <div class="section-title">Route Optimization</div>
                    </div>
                    
                    <div class="route-info" id="routeInfo" style="display: none;">
                        <div class="section-header">
                            <i class="fas fa-route section-icon"></i>
                            <div class="section-title">Optimization Results</div>
                        </div>
                        <div class="route-summary" id="routeSummary"></div>
                    </div>
                    
                    <div class="map-container">
                        <div id="optimize-map"></div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div id="statistics-section" class="section" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-chart-bar section-icon"></i>
                        <div class="section-title">Transport Statistics</div>
                    </div>
                    
                    <div class="stats-grid" id="stats" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-number" id="totalPoints">0</div>
                            <div class="stat-label">Boarding Points</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalClusters">0</div>
                            <div class="stat-label">Transport Routes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalDistance">0</div>
                            <div class="stat-label">Total Distance (km)</div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="section" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-cog section-icon"></i>
                        <div class="section-title">Settings</div>
                    </div>
                    
                    <div class="upload-section">
                        <h3 style="color: #ffffff; margin-bottom: 15px;">Algorithm Parameters</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <label style="color: #ccc; display: block; margin-bottom: 5px;">Max Students per Bus</label>
                                <input type="number" value="55" style="width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #ffffff;">
                            </div>
                            <div>
                                <label style="color: #ccc; display: block; margin-bottom: 5px;">Max Route Distance (km)</label>
                                <input type="number" value="40" style="width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #ffffff;">
                            </div>
                            <div>
                                <label style="color: #ccc; display: block; margin-bottom: 5px;">Max Route Time (min)</label>
                                <input type="number" value="120" style="width: 100%; padding: 8px; background: #0f0f0f; border: 1px solid #333; border-radius: 6px; color: #ffffff;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let boardingPoints = [];
        let clusterColors = {};
        let optimizedRoutes = [];
        let currentFile = null;
        let dataLoaded = false;

        // Navigation
        function showSection(sectionName, navItem) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';

            // Add active class to clicked nav item
            if (navItem) {
                navItem.classList.add('active');
            } else {
                // Fallback: add active to the nav-item matching the section
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    if (item.getAttribute('data-section') === sectionName) {
                        item.classList.add('active');
                    }
                });
            }

            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'upload': 'Upload Data',
                'visualize': 'Visualize Points',
                'optimize': 'Optimize Routes',
                'statistics': 'Statistics',
                'settings': 'Settings'
            };
            document.querySelector('.page-title').textContent = titles[sectionName];

            // Handle section-specific actions
            if (sectionName === 'visualize' && dataLoaded && boardingPoints.length > 0) {
                displayPoints();
            } else if (sectionName === 'optimize') {
                // Always initialize optimize map when showing optimize section
                console.log('Initializing optimize map...');
                
                // Add a longer delay to ensure the container is rendered and API is loaded
                setTimeout(() => {
                    initOptimizeMap();
                    
                    // If optimized routes exist, display them after map is ready
                    if (optimizedRoutes.length > 0) {
                        setTimeout(() => {
                            console.log('Displaying optimized routes...');
                            displayOptimizedRoutes();
                            updateOptimizedLegend();
                        }, 1000);
                    } else {
                        console.log('No optimized routes to display');
                    }
                }, 500);
            }
        }

        // Attach click handler to nav-items to track last clicked (no inline onclick)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                const sectionName = this.getAttribute('data-section');
                showSection(sectionName, this);
            });
        });

        // Initialize Google Maps
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 13.0827, lng: 80.2707 },
                zoom: 10,
                styles: [
                    {
                        featureType: 'all',
                        elementType: 'geometry',
                        stylers: [{ color: '#1a1a1a' }]
                    },
                    {
                        featureType: 'all',
                        elementType: 'labels.text.stroke',
                        stylers: [{ color: '#1a1a1a' }]
                    },
                    {
                        featureType: 'all',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#7c3aed' }]
                    },
                    {
                        featureType: 'administrative.locality',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'geometry',
                        stylers: [{ color: '#263c3f' }]
                    },
                    {
                        featureType: 'poi.park',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#6b9a76' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry',
                        stylers: [{ color: '#2a2a2a' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'geometry.stroke',
                        stylers: [{ color: '#333' }]
                    },
                    {
                        featureType: 'road',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#9ca5b3' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry',
                        stylers: [{ color: '#374151' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'geometry.stroke',
                        stylers: [{ color: '#4b5563' }]
                    },
                    {
                        featureType: 'road.highway',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#f3d19c' }]
                    },
                    {
                        featureType: 'transit',
                        elementType: 'geometry',
                        stylers: [{ color: '#1f2937' }]
                    },
                    {
                        featureType: 'transit.station',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#d59563' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'geometry',
                        stylers: [{ color: '#17263c' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.fill',
                        stylers: [{ color: '#515c6d' }]
                    },
                    {
                        featureType: 'water',
                        elementType: 'labels.text.stroke',
                        stylers: [{ color: '#17263c' }]
                    }
                ]
            });
        }

        // Initialize Optimize Map
        function initOptimizeMap() {
            console.log('initOptimizeMap called');
            const mapContainer = document.getElementById('optimize-map');
            console.log('Map container:', mapContainer);
            
            // Check if Google Maps API is loaded
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.log('Google Maps API not loaded yet, retrying in 500ms...');
                setTimeout(initOptimizeMap, 500);
                return;
            }
            
            if (!window.optimizeMap && mapContainer) {
                console.log('Creating optimize map...');
                try {
                    window.optimizeMap = new google.maps.Map(mapContainer, {
                        center: { lat: 13.0827, lng: 80.2707 },
                        zoom: 10,
                        styles: [
                            {
                                featureType: 'all',
                                elementType: 'geometry',
                                stylers: [{ color: '#1a1a1a' }]
                            },
                            {
                                featureType: 'all',
                                elementType: 'labels.text.stroke',
                                stylers: [{ color: '#1a1a1a' }]
                            },
                            {
                                featureType: 'all',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#7c3aed' }]
                            },
                            {
                                featureType: 'administrative.locality',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#d59563' }]
                            },
                            {
                                featureType: 'poi',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#d59563' }]
                            },
                            {
                                featureType: 'poi.park',
                                elementType: 'geometry',
                                stylers: [{ color: '#263c3f' }]
                            },
                            {
                                featureType: 'poi.park',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#6b9a76' }]
                            },
                            {
                                featureType: 'road',
                                elementType: 'geometry',
                                stylers: [{ color: '#2a2a2a' }]
                            },
                            {
                                featureType: 'road',
                                elementType: 'geometry.stroke',
                                stylers: [{ color: '#333' }]
                            },
                            {
                                featureType: 'road',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#9ca5b3' }]
                            },
                            {
                                featureType: 'road.highway',
                                elementType: 'geometry',
                                stylers: [{ color: '#374151' }]
                            },
                            {
                                featureType: 'road.highway',
                                elementType: 'geometry.stroke',
                                stylers: [{ color: '#4b5563' }]
                            },
                            {
                                featureType: 'road.highway',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#f3d19c' }]
                            },
                            {
                                featureType: 'transit',
                                elementType: 'geometry',
                                stylers: [{ color: '#1f2937' }]
                            },
                            {
                                featureType: 'transit.station',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#d59563' }]
                            },
                            {
                                featureType: 'water',
                                elementType: 'geometry',
                                stylers: [{ color: '#17263c' }]
                            },
                            {
                                featureType: 'water',
                                elementType: 'labels.text.fill',
                                stylers: [{ color: '#515c6d' }]
                            },
                            {
                                featureType: 'water',
                                elementType: 'labels.text.stroke',
                                stylers: [{ color: '#17263c' }]
                            }
                        ]
                    });
                    console.log('Optimize map created successfully');
                    
                    // Force a resize event to ensure map displays properly
                    setTimeout(() => {
                        if (window.optimizeMap) {
                            console.log('Triggering map resize...');
                            google.maps.event.trigger(window.optimizeMap, 'resize');
                            window.optimizeMap.setCenter({ lat: 13.0827, lng: 80.2707 });
                            window.optimizeMap.setZoom(10);
                        }
                    }, 100);
                    
                } catch (error) {
                    console.error('Error creating optimize map:', error);
                }
            } else if (window.optimizeMap) {
                console.log('Optimize map already exists');
                // Force a resize event even if map already exists
                setTimeout(() => {
                    console.log('Triggering existing map resize...');
                    google.maps.event.trigger(window.optimizeMap, 'resize');
                    window.optimizeMap.setCenter({ lat: 13.0827, lng: 80.2707 });
                    window.optimizeMap.setZoom(10);
                }, 100);
            } else {
                console.log('Map container not found, retrying in 500ms...');
                setTimeout(initOptimizeMap, 500);
            }
        }

        // Simple and direct file input control
        const fileInput = document.getElementById('csvFile');
        const uploadArea = document.getElementById('fileUpload');
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadBtn');
            const routeBtn = document.getElementById('routeBtn');
            const fileInfo = document.getElementById('fileInfo');
            const message = document.getElementById('message');

            if (file) {
                // Only set currentFile if it's a new file
                if (!currentFile || currentFile.name !== file.name || currentFile.size !== file.size) {
                    currentFile = file;
                    dataLoaded = false; // Reset data loaded flag only for new file
                }
                uploadBtn.disabled = false;
                routeBtn.disabled = false;
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `
                    <h4><i class="fas fa-file-csv"></i> File Selected</h4>
                    <p><strong>Name:</strong> ${file.name}</p>
                    <p><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB</p>
                    <p><strong>Type:</strong> ${file.type || 'text/csv'}</p>
                `;
                message.innerHTML = '';
            } else {
                currentFile = null;
                uploadBtn.disabled = true;
                routeBtn.disabled = true;
                fileInfo.style.display = 'none';
                dataLoaded = false;
            }
        });

        // Only allow file input when clicking directly on upload area
        uploadArea.addEventListener('click', function(e) {
            // Only trigger if clicking on the upload area itself or its text elements
            if (e.target === this || 
                e.target.classList.contains('upload-icon') || 
                e.target.classList.contains('upload-text') || 
                e.target.classList.contains('upload-subtext')) {
                fileInput.click();
            }
        });

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Assign files and trigger change event only if not already the same file
                if (!fileInput.files.length || fileInput.files[0].name !== files[0].name || fileInput.files[0].size !== files[0].size) {
                    fileInput.files = files;
                    // Only trigger change event if file is different
                    fileInput.dispatchEvent(new Event('change'));
                }
            }
        });

        // Upload button handling
        document.getElementById('uploadBtn').addEventListener('click', function(e) {
            // Prevent re-triggering file input or reloading file if already loaded
            if (!currentFile) return;

            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            const stats = document.getElementById('stats');
            const legend = document.getElementById('legend');

            loading.style.display = 'block';
            document.getElementById('loadingText').textContent = 'Processing transport data...';
            message.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    const requiredHeaders = ['cluster', 'student_count', 'bus_stop_lat', 'bus_stop_lon'];
                    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                    
                    if (missingHeaders.length > 0) {
                        throw new Error(`Missing required columns: ${missingHeaders.join(', ')}`);
                    }

                    boardingPoints = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim());
                            const point = {
                                cluster: values[headers.indexOf('cluster')],
                                student_count: parseInt(values[headers.indexOf('student_count')]) || 0,
                                lat: parseFloat(values[headers.indexOf('bus_stop_lat')]),
                                lng: parseFloat(values[headers.indexOf('bus_stop_lon')])
                            };
                            
                            if (!isNaN(point.lat) && !isNaN(point.lng)) {
                                boardingPoints.push(point);
                            }
                        }
                    }

                    if (boardingPoints.length === 0) {
                        throw new Error('No valid boarding points found in the CSV file');
                    }

                    // Initialize map if not already done
                    if (!map) {
                        initMap();
                    }

                    displayPoints();
                    updateStats();
                    updateLegend();
                    updateDashboard();
                    
                    // Set data loaded flag
                    dataLoaded = true;
                    
                    // Show success message and display stats
                    message.innerHTML = `<div class="success"><i class="fas fa-check-circle"></i> Successfully loaded ${boardingPoints.length} boarding points!</div>`;
                    stats.style.display = 'grid';
                    legend.style.display = 'block';
                    
                    // Switch to visualize section to show the map
                    setTimeout(() => {
                        showSection('visualize');
                    }, 500);

                } catch (error) {
                    message.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
                } finally {
                    loading.style.display = 'none';
                }
            };

            reader.readAsText(currentFile);
        });

        // Route optimization button handling
        document.getElementById('routeBtn').addEventListener('click', function(e) {
            if (!currentFile) return;

            const loading = document.getElementById('loading');
            const message = document.getElementById('message');
            const routeInfo = document.getElementById('routeInfo');

            loading.style.display = 'block';
            document.getElementById('loadingText').textContent = 'Optimizing routes with enhanced algorithm... This should be much faster now!';
            message.innerHTML = '';

            const formData = new FormData();
            formData.append('file', currentFile);

            const startTime = Date.now();

            fetch('http://localhost:5000/api/optimize', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const endTime = Date.now();
                const clientTime = (endTime - startTime) / 1000;
                
                console.log('API Response:', data); // Debug log
                console.log('API Response structure:', {
                    success: data.success,
                    hasData: !!data.data,
                    dataKeys: data.data ? Object.keys(data.data) : 'no data',
                    hasRoutes: data.data && data.data.routes,
                    routesLength: data.data && data.data.routes ? data.data.routes.length : 'no routes',
                    hasSummary: data.data && data.data.summary,
                    summaryKeys: data.data && data.data.summary ? Object.keys(data.data.summary) : 'no summary'
                });
                
                // Additional debugging for routes structure
                if (data.data && data.data.routes) {
                    console.log('First route sample:', data.data.routes[0]);
                    console.log('Routes structure check:', {
                        hasStops: data.data.routes[0] && data.data.routes[0].stops,
                        stopsLength: data.data.routes[0] && data.data.routes[0].stops ? data.data.routes[0].stops.length : 'no stops',
                        firstStop: data.data.routes[0] && data.data.routes[0].stops ? data.data.routes[0].stops[0] : 'no first stop'
                    });
                }
                
                if (data.success) {
                    optimizedRoutes = data.data.routes;
                    console.log('Optimized Routes:', optimizedRoutes); // Debug log
                    
                    // Initialize optimize map if not already done
                    if (!window.optimizeMap) {
                        console.log('Initializing optimize map from route optimization...');
                        initOptimizeMap();
                    } else {
                        console.log('Optimize map already exists');
                    }
                    
                    // Add a delay to ensure map is ready
                    setTimeout(() => {
                        displayOptimizedRoutes();
                        updateRouteSummary(data.data.summary);
                        updateDashboard();
                        updateOptimizedLegend(); // Update legend for optimized routes
                        
                        const serverTime = data.data.processing_time_seconds || 0;
                        message.innerHTML = `
                            <div class="success">
                                <i class="fas fa-check-circle"></i> 
                                Route optimization completed! Generated ${data.data.summary.total_buses_needed} routes.
                                <br><small>Server processing time: ${serverTime.toFixed(2)}s | Total time: ${clientTime.toFixed(2)}s</small>
                            </div>
                        `;
                        routeInfo.style.display = 'block';
                        
                        // Switch to optimize section to show the routes
                        console.log('Switching to optimize section...');
                        showSection('optimize');
                    }, 1000);
                } else {
                    message.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                message.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            })
            .finally(() => {
                loading.style.display = 'none';
            });
        });

        // Display points on map
        function displayPoints() {
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            clusterColors = {};

            if (boardingPoints.length === 0) return;

            const bounds = new google.maps.LatLngBounds();

            boardingPoints.forEach((point, index) => {
                if (!clusterColors[point.cluster]) {
                    clusterColors[point.cluster] = getClusterColor(Object.keys(clusterColors).length);
                }

                const busIcon = {
                    url: createBusIcon(clusterColors[point.cluster]),
                    scaledSize: new google.maps.Size(40, 40),
                    origin: new google.maps.Point(0, 0),
                    anchor: new google.maps.Point(20, 20)
                };

                const marker = new google.maps.Marker({
                    position: { lat: point.lat, lng: point.lng },
                    map: map,
                    title: `Route: ${point.cluster}, Students: ${point.student_count}`,
                    icon: busIcon
                });

                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="padding: 15px; min-width: 250px; font-family: 'Inter', sans-serif; color: #1a1a1a;">
                            <h3 style="margin: 0 0 15px 0; color: #1a1a1a; font-size: 1.2rem;">
                                <i class="fas fa-bus" style="color: ${clusterColors[point.cluster]}"></i> Boarding Point
                            </h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <p style="margin: 8px 0; color: #495057;"><strong>Route:</strong> ${point.cluster}</p>
                                <p style="margin: 8px 0; color: #495057;"><strong>Students:</strong> ${point.student_count}</p>
                                <p style="margin: 8px 0; color: #495057;"><strong>Location:</strong> ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</p>
                            </div>
                        </div>
                    `
                });

                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
                bounds.extend(marker.getPosition());
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                map.fitBounds(bounds);
                if (markers.length === 1) {
                    map.setZoom(15);
                }
            }
        }

        // Check if optimize map is ready
        function isOptimizeMapReady() {
            const isReady = window.optimizeMap && typeof window.optimizeMap !== 'undefined';
            console.log('isOptimizeMapReady check:', {
                hasOptimizeMap: !!window.optimizeMap,
                optimizeMapType: typeof window.optimizeMap,
                isReady: isReady
            });
            return isReady;
        }

        // Display optimized routes
        function displayOptimizedRoutes() {
            console.log('displayOptimizedRoutes called');
            console.log('optimizedRoutes length:', optimizedRoutes.length);
            console.log('optimizedRoutes:', optimizedRoutes);
            
            // Check if map is ready
            if (!isOptimizeMapReady()) {
                console.log('Optimize map not ready, retrying in 500ms...');
                setTimeout(displayOptimizedRoutes, 500);
                return;
            }
            
            console.log('Displaying optimized routes on map...');
            
            // Clear existing markers and routes
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // Clear existing polylines
            if (window.routePolylines) {
                window.routePolylines.forEach(polyline => polyline.setMap(null));
            }
            window.routePolylines = [];

            if (optimizedRoutes.length === 0) return;

            const bounds = new google.maps.LatLngBounds();
            const routeColors = {};

            optimizedRoutes.forEach((route, routeIndex) => {
                console.log(`Processing route ${routeIndex}:`, route);
                const routeColor = getClusterColor(routeIndex);
                routeColors[route.bus_id] = routeColor;

                // Create route path
                const routePath = [];
                
                console.log(`Route ${routeIndex} has ${route.stops ? route.stops.length : 'no'} stops`);
                route.stops.forEach((stop, stopIndex) => {
                    console.log(`Stop ${stopIndex}:`, stop);
                    const position = { lat: stop.latitude, lng: stop.longitude };
                    routePath.push(position);
                    
                    let icon;
                    if (stop.type === 'college_start' || stop.type === 'college_end') {
                        icon = {
                            url: createCollegeIcon(),
                            scaledSize: new google.maps.Size(50, 50),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(25, 25)
                        };
                    } else {
                        icon = {
                            url: createBusIcon(routeColor),
                            scaledSize: new google.maps.Size(40, 40),
                            origin: new google.maps.Point(0, 0),
                            anchor: new google.maps.Point(20, 20)
                        };
                    }

                    const marker = new google.maps.Marker({
                        position: position,
                        map: window.optimizeMap, // Use optimizeMap
                        title: `Bus ${route.bus_id}: ${stop.name}`,
                        icon: icon,
                        label: {
                            text: (stop.type === 'college_start' || stop.type === 'college_end') ? 'C' : stop.students.toString(),
                            color: 'white',
                            fontSize: '12px',
                            fontWeight: 'bold'
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 15px; min-width: 250px; font-family: 'Inter', sans-serif; color: #1a1a1a;">
                                <h3 style="margin: 0 0 15px 0; color: #1a1a1a; font-size: 1.2rem;">
                                    <i class="fas fa-bus" style="color: ${routeColor}"></i> Bus ${route.bus_id}
                                </h3>
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="margin: 8px 0; color: #495057;"><strong>Stop:</strong> ${stop.name}</p>
                                    <p style="margin: 8px 0; color: #495057;"><strong>Students:</strong> ${stop.students}</p>
                                    <p style="margin: 8px 0; color: #495057;"><strong>Type:</strong> ${stop.type}</p>
                                    <p style="margin: 8px 0; color: #495057;"><strong>Route Distance:</strong> ${(route.total_distance_km || route.distance_km || 0).toFixed(2)} km</p>
                                    <p style="margin: 8px 0; color: #495057;"><strong>Route Time:</strong> ${((route.total_duration_hours || route.duration_hours || 0) * 60).toFixed(0)} min</p>
                                </div>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(window.optimizeMap, marker); // Use optimizeMap
                    });

                    markers.push(marker);
                    bounds.extend(position);
                });

                // Create route polyline - use OSRM polyline if available, otherwise use route path
                console.log(`Creating polyline for route ${route.bus_id} with ${routePath.length} points`);
                
                let polylinePath = routePath;
                
                // If we have a Google Directions polyline, decode and use it for road-following route
                if (route.polyline && route.polyline.trim() !== '') {
                    const decodedPath = decodePolyline(route.polyline);
                    if (decodedPath && decodedPath.length > 0) {
                        polylinePath = decodedPath;
                        console.log(`Using Google Directions polyline with ${decodedPath.length} points for route ${route.bus_id}`);
                    } else {
                        console.warn(`Failed to decode polyline for route ${route.bus_id}, using direct path`);
                    }
                }
                
                const polyline = new google.maps.Polyline({
                    path: polylinePath,
                    geodesic: false, // Set to false for road-following routes
                    strokeColor: routeColor,
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    map: window.optimizeMap // Use optimizeMap
                });

                window.routePolylines.push(polyline);
            });

            // Fit map to show all routes
            console.log('Bounds empty:', bounds.isEmpty());
            if (bounds.isEmpty()) {
                console.log('Setting default center and zoom');
                window.optimizeMap.setCenter({ lat: 13.0827, lng: 80.2707 }); // Use optimizeMap
                window.optimizeMap.setZoom(10); // Use optimizeMap
            } else {
                console.log('Fitting bounds to show all routes');
                window.optimizeMap.fitBounds(bounds); // Use optimizeMap
                // Add some padding to the bounds
                const listener = google.maps.event.addListenerOnce(window.optimizeMap, 'bounds_changed', function() {
                    window.optimizeMap.setZoom(Math.min(window.optimizeMap.getZoom(), 12)); // Use optimizeMap
                });
            }
        }

        // Create bus icon SVG
        function createBusIcon(color) {
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
                    <path d="M8 15h24v8c0 1.1-.9 2-2 2h-2v2h-2v-2H14v2h-2v-2h-2c-1.1 0-2-.9-2-2v-8z" fill="white"/>
                    <circle cx="12" cy="22" r="2" fill="${color}"/>
                    <circle cx="28" cy="22" r="2" fill="${color}"/>
                    <rect x="10" y="17" width="4" height="2" fill="white"/>
                    <rect x="26" y="17" width="4" height="2" fill="white"/>
                </svg>
            `;
            return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
        }

        // Create college icon SVG
        function createCollegeIcon() {
            const svg = `
                <svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="25" cy="25" r="23" fill="#7c3aed" stroke="white" stroke-width="3"/>
                    <path d="M25 8l15 8v8c0 1.1-.9 2-2 2H12c-1.1 0-2-.9-2-2v-8l15-8z" fill="white"/>
                    <rect x="20" y="20" width="10" height="12" fill="white"/>
                    <rect x="22" y="22" width="6" height="2" fill="#7c3aed"/>
                    <rect x="22" y="26" width="6" height="2" fill="#7c3aed"/>
                </svg>
            `;
            return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
        }

        // Generate colors for clusters
        function getClusterColor(index) {
            const colors = [
                '#7c3aed', '#dc2626', '#059669', '#d97706', '#7c2d12',
                '#1e40af', '#be185d', '#15803d', '#a16207', '#92400e',
                '#3730a3', '#be123c', '#166534', '#a16207', '#92400e'
            ];
            return colors[index % colors.length];
        }

        // Fallback polyline decoder function
        function decodePolyline(encoded) {
            if (!encoded) return null;
            
            try {
                // Use Google Maps geometry library if available
                if (google && google.maps && google.maps.geometry) {
                    return google.maps.geometry.encoding.decodePath(encoded);
                }
                
                // Fallback: simple polyline decoder
                const poly = [];
                let index = 0, len = encoded.length;
                let lat = 0, lng = 0;

                while (index < len) {
                    let b, shift = 0, result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lat += dlat;

                    shift = 0;
                    result = 0;
                    do {
                        b = encoded.charCodeAt(index++) - 63;
                        result |= (b & 0x1f) << shift;
                        shift += 5;
                    } while (b >= 0x20);
                    let dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                    lng += dlng;

                    poly.push({ lat: lat / 1E5, lng: lng / 1E5 });
                }
                return poly;
            } catch (e) {
                console.warn('Failed to decode polyline:', e);
                return null;
            }
        }

        // Update statistics
        function updateStats() {
            const totalPoints = boardingPoints.length;
            const totalStudents = boardingPoints.reduce((sum, point) => sum + point.student_count, 0);
            const totalClusters = new Set(boardingPoints.map(point => point.cluster)).size;

            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalClusters').textContent = totalClusters;
        }

        // Update legend
        function updateLegend() {
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';

            Object.keys(clusterColors).forEach(cluster => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${clusterColors[cluster]}"></div>
                    <span><i class="fas fa-bus"></i> ${cluster}</span>
                `;
                legendItems.appendChild(item);
            });
        }

        // Update legend for optimized routes
        function updateOptimizedLegend() {
            const legendItems = document.getElementById('legendItems');
            legendItems.innerHTML = '';

            optimizedRoutes.forEach((route, index) => {
                const routeColor = getClusterColor(index);
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${routeColor}"></div>
                    <span><i class="fas fa-bus"></i> Bus ${route.bus_id} (${route.total_students || route.students || 0} students)</span>
                `;
                legendItems.appendChild(item);
            });

            // Show legend
            document.getElementById('legend').style.display = 'block';
        }

        // Update dashboard
        function updateDashboard() {
            console.log('updateDashboard called');
            console.log('optimizedRoutes length:', optimizedRoutes.length);
            console.log('optimizedRoutes sample:', optimizedRoutes.slice(0, 2));
            
            const totalPoints = boardingPoints.length;
            const totalStudents = boardingPoints.reduce((sum, point) => sum + point.student_count, 0);
            const totalClusters = new Set(boardingPoints.map(point => point.cluster)).size;
            const totalDistance = optimizedRoutes.reduce((sum, route) => sum + (route.total_distance_km || route.distance_km || 0), 0);

            console.log('Dashboard values:', {
                totalPoints,
                totalStudents,
                totalClusters,
                optimizedRoutesLength: optimizedRoutes.length,
                totalDistance
            });

            document.getElementById('dashboardPoints').textContent = totalPoints;
            document.getElementById('dashboardStudents').textContent = totalStudents;
            document.getElementById('dashboardRoutes').textContent = optimizedRoutes.length || totalClusters;
            document.getElementById('dashboardDistance').textContent = totalDistance.toFixed(1);
        }

        // Update route summary
        function updateRouteSummary(summary) {
            console.log('updateRouteSummary called with:', summary);
            console.log('Summary keys:', Object.keys(summary || {}));
            console.log('Summary values:', {
                total_buses_needed: summary?.total_buses_needed,
                total_students_covered: summary?.total_students_covered,
                total_fleet_distance_km: summary?.total_fleet_distance_km,
                total_fleet_duration_hours: summary?.total_fleet_duration_hours
            });
            
            const routeSummary = document.getElementById('routeSummary');
            routeSummary.innerHTML = `
                <div class="route-stat">
                    <div class="route-stat-number">${summary?.total_buses_needed || summary?.total_buses || 0}</div>
                    <div class="route-stat-label">Total Routes</div>
                </div>
                <div class="route-stat">
                    <div class="route-stat-number">${summary?.total_students_covered || summary?.total_students || 0}</div>
                    <div class="route-stat-label">Total Students</div>
                </div>
                <div class="route-stat">
                    <div class="route-stat-number">${(summary?.total_fleet_distance_km || summary?.total_distance_km || 0).toFixed(1)}</div>
                    <div class="route-stat-label">Total Distance (km)</div>
                </div>
                <div class="route-stat">
                    <div class="route-stat-number">${((summary?.total_fleet_duration_hours || summary?.average_duration_hours || 0) * 60).toFixed(0)}</div>
                    <div class="route-stat-label">Avg Time (min)</div>
                </div>
            `;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            showSection('dashboard');
            
            // Initialize map on page load
            setTimeout(() => {
                if (!map) {
                    initMap();
                }
            }, 1000);
        });
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlfqs5K9HEe9c1Eu5bjPXXjr8Hz2mbTZE&libraries=geometry&callback=initMap">
    </script>
</body>
</html> 